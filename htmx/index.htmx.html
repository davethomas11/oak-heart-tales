<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>HTMX Game Render</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="./game.js"></script>
    <script>window.game_data_files = [];</script>
    <script type="application/json" src="../data/tileset.json"></script>
    <script type="application/json" src="../data/enemies.json"></script>
    <script type="text/plain" src="../data/rooms/ashen_hollow.txt"></script>
    <script type="text/plain" src="../data/rooms/blightmoor.txt"></script>
    <script type="text/plain" src="../data/rooms/crystal_cavern.txt"></script>
    <script type="text/plain" src="../data/rooms/eastgate_road.txt"></script>
    <script type="text/plain" src="../data/rooms/emberfall.txt"></script>
    <script type="text/plain" src="../data/rooms/frost_creek.txt"></script>
    <script type="text/plain" src="../data/rooms/gloomwood.txt"></script>
    <script type="text/plain" src="../data/rooms/ironfang_pass.txt"></script>
    <script type="text/plain" src="../data/rooms/mire_flats.txt"></script>
    <script type="text/plain" src="../data/rooms/northern_ridge.txt"></script>
    <script type="text/plain" src="../data/rooms/oakheart_village.txt"></script>
    <script type="text/plain" src="../data/rooms/old_watchtower.txt"></script>
    <script type="text/plain" src="../data/rooms/ruined_keep.txt"></script>
    <script type="text/plain" src="../data/rooms/shattered_obelisk.txt"></script>
    <script type="text/plain" src="../data/rooms/sunken_ruins.txt"></script>
    <script type="text/plain" src="../data/rooms/western_farms.txt"></script>
    <script type="text/plain" src="../data/rooms/whispering_gorge.txt"></script>


    <script>
        var playerModule = require("player");
        var worldModule = require("world");
        var gameModule = require("game");

        function newGame(mapSize) {
            const tileset = JSON.parse(window.game_data_files["../data/tileset.json"]);
            const player = new playerModule.Player("Hero", 1, 25, 25, 5, 5, 2, 1, 3, [], 0, null, null);
            const grid = generateRandomTilesetGrid(mapSize, tileset);
            const world = new worldModule.World(mapSize, mapSize, grid, getSeedFromGeneratedGrid(grid));
            const game = new gameModule.Game(world, player, Math.floor(mapSize / 2), Math.floor(mapSize / 2));
            initializeGameModule(game);
            return game
        }

        function getSeedFromGeneratedGrid(grid) {
            const str = grid.flat().map(tile => tile.name || tile.py_name).join("-");
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = ((hash << 5) - hash) + str.charCodeAt(i);
                hash |= 0;
            }
            return Math.abs(hash);
        }

        function generateRandomTilesetGrid(size, tilesetData) {
            const village = tilesetData["village"];
            const tileset = tilesetData["tiles"];
            const grid = [];
            for (let y = 0; y < size; y++) {
                const row = [];
                for (let x = 0; x < size; x++) {
                    const tileKeys = Object.keys(tileset);
                    const randomKey = tileKeys[Math.floor(Math.random() * tileKeys.length)];
                    const tileData = tileset[randomKey];
                    const tile = new worldModule.Tile(tileData.name, tileData.description, tileData.danger, tileData.safe, tileData.ascii);
                    row.push(tile);
                }
                grid.push(row);
            }
            const center = Math.floor(size / 2);
            grid[center][center] = new worldModule.Tile(
                village.name, village.description, village.danger,
                village.safe, village.ascii, village.shop
            );
            return grid;
        }

       function initializeGameModule(game) {
            game.data_loader = {
                load: (loadJsonFile) => {
                    return JSON.parse(window.game_data_files[loadJsonFile]);
                }
            }
            game.ascii_loader = {
                load: (loadTextFile) => {
                    return window.game_data_files["../data/rooms/" + loadTextFile];
                }
            }
            game.load_configurations("../data/enemies.json");
        }
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const game = await newGame(20);
            window.game = game; // Expose game globally for debugging
            const gameText = document.getElementById("game-text");
            this.gameText = this.game.look();
            gameText.innerHTML = this.game.look();
        });
    </script>
</head>
<body>
<div id="game-container">
    <pre id="game-text">
        Loading game...
    </pre>
    <!-- Game will render here -->
</div>
</body>
</html>